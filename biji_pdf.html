<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF查看器 - 修复版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#F97316',
                        neutral: '#F8FAFC',
                        paper: '#FEFEFA',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    borderRadius: {
                        'extra-large': '1.5rem',
                    },
                    boxShadow: {
                        'elevation-1': '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)',
                        'elevation-2': '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)',
                        'elevation-3': '0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)',
                        'elevation-4': '0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22)',
                        'elevation-5': '0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22)',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .page-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .nav-link {
                @apply text-primary hover:text-secondary transition-colors duration-200;
            }
            .hover-lift {
                @apply transition-all duration-300 hover:shadow-elevation-3 hover:-translate-y-1;
            }
            .pdf-loading {
                @apply animate-pulse opacity-70;
            }
            .mobile-nav-active {
                @apply bg-primary/10 text-primary;
            }
            .canvas-container {
                @apply w-full overflow-hidden rounded-2xl;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- 顶部导航栏 -->
    <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-sm shadow-elevation-2 z-50 transition-all duration-300">
        <div class="container mx-auto px-3 py-2 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <button id="file-menu-btn" class="p-2.5 rounded-full hover:bg-gray-100 transition-all hover-lift">
                    <i class="fa fa-bars text-dark"></i>
                </button>
                <h1 class="text-base font-medium text-dark hidden sm:block">PDF查看器</h1>
            </div>
            
            <!-- 搜索框 -->
            <div class="relative flex-1 max-w-md mx-3">
                <input type="text" id="search-input" placeholder="搜索PDF内容..." 
                       class="w-full py-2 px-3 pr-8 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm text-sm">
                <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-primary hover-lift">
                    <i class="fa fa-search"></i>
                </button>
            </div>
            
            <div class="flex items-center space-x-1">
                <button id="outline-toggle" class="p-2.5 rounded-full hover:bg-gray-100 transition-all hover-lift">
                    <i class="fa fa-list text-dark"></i>
                </button>
                <button id="theme-toggle" class="p-2.5 rounded-full hover:bg-gray-100 transition-all hover-lift">
                    <i class="fa fa-moon-o text-dark"></i>
                </button>
            </div>
        </div>
        
        <!-- 文件菜单 -->
        <div id="file-menu" class="absolute top-full left-0 right-0 bg-white shadow-elevation-3 transform -translate-y-full opacity-0 transition-all duration-300 pointer-events-none">
            <div class="container mx-auto px-4 py-3">
                <div class="flex flex-col space-y-3">
                    <div class="relative">
                        <input type="text" id="url-input" placeholder="输入PDF链接..." 
                               class="w-full py-3 px-4 pr-10 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all shadow-sm">
                        <button id="load-url-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-primary hover-lift">
                            <i class="fa fa-external-link"></i>
                        </button>
                    </div>
                    <label for="file-input" class="flex items-center space-x-3 p-3 rounded-xl border border-dashed border-gray-300 hover:border-primary hover:bg-primary/5 cursor-pointer transition-all hover-lift">
                        <i class="fa fa-file-pdf-o text-primary"></i>
                        <span>选择本地PDF文件</span>
                    </label>
                    <input type="file" id="file-input" accept=".pdf" class="hidden">
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="pt-16 pb-8 min-h-screen">
        <div id="pdf-container" class="container mx-auto px-2 py-4 flex flex-col items-center space-y-3">
            <!-- PDF页面将在这里渲染 -->
            <div id="placeholder" class="w-full h-96 flex flex-col items-center justify-center bg-paper rounded-2xl shadow-elevation-2 border border-gray-100">
                <i class="fa fa-file-pdf-o text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-xl font-medium text-gray-500 mb-2">请选择或输入PDF文件</h2>
                <p class="text-gray-400 text-sm">支持本地文件上传和在线PDF链接</p>
            </div>
            
            <!-- 加载指示器 -->
            <div id="loading-indicator" class="hidden w-full py-8 flex flex-col items-center justify-center">
                <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-gray-500">正在加载PDF，请稍候...</p>
            </div>
            
            <!-- 错误提示 -->
            <div id="error-message" class="hidden w-full p-6 bg-red-50 rounded-2xl border border-red-200 text-red-600 text-center">
                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                <p id="error-text">加载PDF时发生错误</p>
            </div>
        </div>
    </main>

    <!-- 搜索结果面板 -->
    <div id="search-results" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-elevation-3 transform translate-y-full transition-all duration-300 z-40 max-h-[50vh]">
        <div class="p-3 border-b border-gray-200 flex justify-between items-center rounded-t-2xl">
            <h3 class="font-medium text-dark">搜索结果</h3>
            <button id="close-results" class="p-2 rounded-full hover:bg-gray-100 hover-lift">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="results-list" class="p-3 max-h-[calc(50vh-64px)] overflow-y-auto scrollbar-hide space-y-2">
            <!-- 搜索结果将在这里显示 -->
        </div>
    </div>

    <!-- 右侧大纲导航 -->
    <div id="outline-panel" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="absolute top-0 right-0 bottom-0 w-[85%] max-w-sm bg-white shadow-elevation-4 transform translate-x-full transition-transform duration-300 rounded-l-2xl overflow-y-auto">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center rounded-l-2xl">
                <h3 class="font-medium text-dark">文档大纲</h3>
                <button id="close-outline" class="p-2 rounded-full hover:bg-gray-100 hover-lift">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="outline-list" class="p-3 space-y-2">
                <!-- 大纲将在这里生成 -->
                <div class="text-gray-400 text-sm text-center py-8">
                    <i class="fa fa-spinner fa-spin mb-2"></i>
                    <p>加载大纲中...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let pageElements = [];
        let outlines = [];
        let searchResults = [];
        let currentSearchIndex = 0;
        let isMobile = window.innerWidth < 640;
        let isDarkMode = false;
        
        // DOM元素
        const pdfContainer = document.getElementById('pdf-container');
        const placeholder = document.getElementById('placeholder');
        const fileInput = document.getElementById('file-input');
        const fileMenuBtn = document.getElementById('file-menu-btn');
        const fileMenu = document.getElementById('file-menu');
        const urlInput = document.getElementById('url-input');
        const loadUrlBtn = document.getElementById('load-url-btn');
        const outlineToggle = document.getElementById('outline-toggle');
        const outlinePanel = document.getElementById('outline-panel');
        const outlineList = document.getElementById('outline-list');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResultsPanel = document.getElementById('search-results');
        const resultsList = document.getElementById('results-list');
        const closeResultsBtn = document.getElementById('close-results');
        const themeToggle = document.getElementById('theme-toggle');
        const loadingIndicator = document.getElementById('loading-indicator');
        const closeOutlineBtn = document.getElementById('close-outline');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // 初始化事件监听器
        function initEventListeners() {
            // 文件菜单
            fileMenuBtn.addEventListener('click', toggleFileMenu);
            fileInput.addEventListener('change', handleFileSelect);
            loadUrlBtn.addEventListener('click', handleUrlLoad);
            
            // 大纲导航
            outlineToggle.addEventListener('click', toggleOutlinePanel);
            closeOutlineBtn.addEventListener('click', toggleOutlinePanel);
            outlinePanel.addEventListener('click', (e) => {
                if (e.target === outlinePanel) {
                    toggleOutlinePanel();
                }
            });
            
            // 搜索功能
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            
            closeResultsBtn.addEventListener('click', () => {
                searchResultsPanel.classList.add('translate-y-full');
            });
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 滚动监听 - 高亮当前可见章节
            window.addEventListener('scroll', highlightCurrentSection);
            
            // 窗口大小变化监听
            window.addEventListener('resize', handleResize);
        }
        
        // 处理窗口大小变化
        function handleResize() {
            const newIsMobile = window.innerWidth < 640;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
            }
            
            // 重新渲染页面以适应新的屏幕尺寸
            if (pdfDoc) {
                renderAllPages();
            }
        }
        
        // 切换文件菜单
        function toggleFileMenu() {
            if (fileMenu.classList.contains('opacity-0')) {
                fileMenu.classList.remove('opacity-0', '-translate-y-full', 'pointer-events-none');
                fileMenu.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
            } else {
                fileMenu.classList.add('opacity-0', '-translate-y-full', 'pointer-events-none');
                fileMenu.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
            }
        }
        
        // 切换大纲面板
        function toggleOutlinePanel() {
            const outlineContent = outlinePanel.querySelector('div');
            
            if (outlinePanel.classList.contains('hidden')) {
                outlinePanel.classList.remove('hidden');
                setTimeout(() => {
                    outlineContent.classList.remove('translate-x-full');
                }, 10);
            } else {
                outlineContent.classList.add('translate-x-full');
                setTimeout(() => {
                    outlinePanel.classList.add('hidden');
                }, 300);
            }
        }
        
        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const typedArray = new Uint8Array(this.result);
                loadPDF(typedArray);
                toggleFileMenu();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 处理URL加载
        function handleUrlLoad() {
            const url = urlInput.value.trim();
            if (!url) return;
            
            loadPDF(url);
            toggleFileMenu();
        }
        
        // 加载PDF
        function loadPDF(source) {
            // 重置状态
            errorMessage.classList.add('hidden');
            placeholder.style.display = 'none';
            loadingIndicator.classList.remove('hidden');
            pdfContainer.innerHTML = '';
            pdfContainer.appendChild(loadingIndicator);
            
            // 尝试加载PDF
            pdfjsLib.getDocument(source).promise.then((pdf) => {
                pdfDoc = pdf;
                totalPages = pdf.numPages;
                pageElements = new Array(totalPages);
                
                // 串行渲染所有页面，确保顺序正确
                let pageNumber = 1;
                
                function renderNextPage() {
                    if (pageNumber > totalPages) {
                        // 所有页面渲染完成
                        loadingIndicator.classList.add('hidden');
                        parseOutlines();
                        showToast(`PDF加载完成，共 ${totalPages} 页`);
                        return;
                    }
                    
                    renderPage(pageNumber).then(() => {
                        pageNumber++;
                        renderNextPage();
                    }).catch(error => {
                        console.error(`渲染第 ${pageNumber} 页失败:`, error);
                        showToast(`渲染第 ${pageNumber} 页失败`);
                        renderNextPage(); // 继续渲染下一页
                    });
                }
                
                renderNextPage();
            }).catch((error) => {
                console.error('加载PDF失败:', error);
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorText.textContent = `加载PDF失败: ${error.message}`;
                showToast('加载PDF失败，请检查文件或URL');
            });
        }
        
        // 重新渲染所有页面以适应屏幕尺寸变化
        function renderAllPages() {
            if (!pdfDoc) return;
            
            // 保存当前滚动位置
            const currentScrollY = window.scrollY;
            
            // 重新渲染所有页面
            for (let i = 0; i < totalPages; i++) {
                const pageNumber = i + 1;
                const pageElement = pageElements[i];
                
                if (pageElement) {
                    // 移除旧页面
                    pageElement.remove();
                }
                
                // 渲染新页面
                renderPage(pageNumber);
            }
            
            // 恢复滚动位置
            window.scrollTo(0, currentScrollY);
        }
        
        // 渲染单个页面
        function renderPage(num) {
            return new Promise((resolve, reject) => {
                // 创建加载占位符
                const loadingPlaceholder = document.createElement('div');
                loadingPlaceholder.className = `w-full aspect-[3/4] bg-gray-100 rounded-2xl mb-3 pdf-loading`;
                loadingPlaceholder.dataset.pageNumber = num;
                pdfContainer.appendChild(loadingPlaceholder);
                
                pdfDoc.getPage(num).then((page) => {
                    // 创建容器元素
                    const pageContainer = document.createElement('div');
                    pageContainer.className = `canvas-container mb-3 ${isDarkMode ? 'bg-gray-700' : 'bg-paper'}`;
                    
                    // 创建Canvas
                    const canvas = document.createElement('canvas');
                    canvas.className = `w-full h-auto page-shadow transition-all duration-300 hover-lift`;
                    canvas.dataset.pageNumber = num;
                    
                    pageContainer.appendChild(canvas);
                    
                    // 获取PDF原始尺寸
                    const viewport = page.getViewport({ scale: 1 });
                    
                    // 计算适合移动端的缩放比例
                    const containerWidth = pdfContainer.clientWidth;
                    
                    // 高清渲染处理
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    
                    // 计算缩放比例，增加安全边距
                    const margin = isMobile ? 12 : 16;
                    const contentWidth = containerWidth - margin * 2;
                    const scale = (contentWidth / viewport.width) * devicePixelRatio;
                    
                    // 创建视口
                    const scaledViewport = page.getViewport({ scale });
                    
                    // 设置Canvas尺寸
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;
                    
                    // 设置CSS尺寸
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                    
                    // 获取Canvas上下文并应用设备像素比
                    const context = canvas.getContext('2d');
                    const pixelRatio = devicePixelRatio;
                    context.scale(pixelRatio, pixelRatio);
                    
                    // 渲染PDF
                    const renderContext = {
                        canvasContext: context,
                        viewport: scaledViewport
                    };
                    
                    const renderTask = page.render(renderContext);
                    renderTask.promise.then(() => {
                        // 替换加载占位符
                        pdfContainer.replaceChild(pageContainer, loadingPlaceholder);
                        pageElements[num - 1] = pageContainer;
                        
                        // 提取页面文本用于搜索
                        page.getTextContent().then((textContent) => {
                            canvas.dataset.textContent = textContent.items.map(item => item.str).join(' ');
                        });
                        
                        resolve();
                    }).catch(error => {
                        reject(error);
                    });
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // 解析大纲
        function parseOutlines() {
            outlineList.innerHTML = '<div class="text-gray-400 text-sm text-center py-8"><i class="fa fa-spinner fa-spin mb-2"></i><p>分析标题中...</p></div>';
            
            // 收集所有页面的文本和字体信息
            const allTextItems = [];
            
            // 先获取所有页面的文本内容
            const getTextPromises = [];
            for (let i = 1; i <= totalPages; i++) {
                getTextPromises.push(
                    pdfDoc.getPage(i).then(page => page.getTextContent())
                );
            }
            
            Promise.all(getTextPromises).then(pagesText => {
                // 找出最大字体大小
                let maxFontSize = 0;
                pagesText.forEach((textContent, pageIndex) => {
                    textContent.items.forEach(item => {
                        // 尝试从transform获取字体大小信息
                        if (item.transform && item.transform[0]) {
                            const fontSize = Math.abs(item.transform[0]);
                            if (fontSize > maxFontSize) {
                                maxFontSize = fontSize;
                            }
                        }
                    });
                });
                
                // 筛选符合条件的标题
                const titlePattern = /^[一二三四五六七八九十百千][、.]\s*.{1,18}$/; // 中文数字开头，长度1-18个字符
                outlines = [];
                
                pagesText.forEach((textContent, pageIndex) => {
                    textContent.items.forEach(item => {
                        if (item.str && item.transform) {
                            const fontSize = Math.abs(item.transform[0]);
                            // 检查是否符合标题条件：字体最大且匹配正则
                            if (fontSize >= maxFontSize * 0.9 && titlePattern.test(item.str.trim())) {
                                outlines.push({
                                    title: item.str.trim(),
                                    page: pageIndex + 1,
                                    top: item.transform[5] // 文本在页面中的位置
                                });
                            }
                        }
                    });
                });
                
                // 渲染大纲列表
                renderOutlineList();
            }).catch(error => {
                console.error('解析大纲失败:', error);
                outlineList.innerHTML = '<div class="text-gray-400 text-sm text-center py-8"><i class="fa fa-exclamation-circle mb-2"></i><p>无法解析大纲</p></div>';
            });
        }
        
        // 渲染大纲列表
        function renderOutlineList() {
            if (outlines.length === 0) {
                outlineList.innerHTML = '<div class="text-gray-400 text-sm text-center py-8"><i class="fa fa-info-circle mb-2"></i><p>未找到符合条件的标题</p></div>';
                return;
            }
            
            outlineList.innerHTML = '';
            outlines.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'outline-item cursor-pointer py-2.5 px-3 rounded-xl hover:bg-gray-50 transition-colors hover-lift';
                listItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-xs text-gray-400 mr-2">${index + 1}.</span>
                        <span class="text-sm text-dark hover:text-primary truncate">${item.title}</span>
                    </div>
                `;
                
                listItem.addEventListener('click', () => {
                    jumpToPage(item.page, item.top);
                    toggleOutlinePanel();
                });
                
                outlineList.appendChild(listItem);
            });
        }
        
        // 跳转到指定页面和位置
        function jumpToPage(pageNum, top = 0) {
            const pageElement = pageElements[pageNum - 1];
            if (pageElement) {
                pageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentPage = pageNum;
                
                // 高亮当前页面
                pageElements.forEach((el, i) => {
                    if (i === pageNum - 1) {
                        el.classList.add('ring-2', 'ring-primary/50');
                    } else {
                        el.classList.remove('ring-2', 'ring-primary/50');
                    }
                });
            }
        }
        
        // 处理搜索
        function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm || !pdfDoc) return;
            
            searchResults = [];
            currentSearchIndex = 0;
            
            // 搜索所有页面
            for (let i = 0; i < pageElements.length; i++) {
                const pageElement = pageElements[i];
                const canvas = pageElement.querySelector('canvas');
                const textContent = canvas ? canvas.dataset.textContent || '' : '';
                
                if (textContent.toLowerCase().includes(searchTerm)) {
                    // 简单实现：查找所有匹配位置
                    const matches = [...textContent.toLowerCase().matchAll(new RegExp(searchTerm, 'g'))];
                    matches.forEach(match => {
                        searchResults.push({
                            page: i + 1,
                            startIndex: match.index,
                            text: textContent.substring(Math.max(0, match.index - 20), match.index + searchTerm.length + 20)
                        });
                    });
                }
            }
            
            // 显示搜索结果
            displaySearchResults();
            
            // 如果有结果，跳转到第一个匹配
            if (searchResults.length > 0) {
                jumpToSearchResult(0);
            } else {
                showToast('未找到匹配结果');
            }
        }
        
        // 显示搜索结果
        function displaySearchResults() {
            resultsList.innerHTML = '';
            
            if (searchResults.length === 0) {
                resultsList.innerHTML = '<div class="text-gray-400 text-center py-4">未找到匹配结果</div>';
                searchResultsPanel.classList.remove('translate-y-full');
                return;
            }
            
            searchResults.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item p-3 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors ${index === currentSearchIndex ? 'bg-primary/10' : ''} hover-lift`;
                
                // 高亮搜索词
                const highlightedText = result.text.replace(
                    new RegExp(searchInput.value, 'gi'),
                    match => `<span class="bg-yellow-200 font-medium rounded">${match}</span>`
                );
                
                resultItem.innerHTML = `
                    <div class="flex items-start">
                        <span class="text-xs text-gray-400 mr-2 mt-0.5">${index + 1}.</span>
                        <div class="flex-1">
                            <div class="text-xs text-primary font-medium">第 ${result.page} 页</div>
                            <div class="text-sm mt-1 line-clamp-2">${highlightedText}</div>
                        </div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    jumpToSearchResult(index);
                });
                
                resultsList.appendChild(resultItem);
            });
            
            searchResultsPanel.classList.remove('translate-y-full');
        }
        
        // 跳转到搜索结果
        function jumpToSearchResult(index) {
            if (index >= 0 && index < searchResults.length) {
                currentSearchIndex = index;
                jumpToPage(searchResults[index].page);
                
                // 更新结果高亮
                const resultItems = resultsList.querySelectorAll('.result-item');
                resultItems.forEach((item, i) => {
                    if (i === index) {
                        item.classList.add('bg-primary/10');
                    } else {
                        item.classList.remove('bg-primary/10');
                    }
                });
            }
        }
        
        // 高亮当前可见章节
        function highlightCurrentSection() {
            if (!outlines || outlines.length === 0) return;
            
            const viewportHeight = window.innerHeight;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollBottom = scrollTop + viewportHeight;
            
            // 找出在视口中的章节
            let currentSection = -1;
            outlines.forEach((outline, index) => {
                const pageElement = pageElements[outline.page - 1];
                if (pageElement) {
                    const rect = pageElement.getBoundingClientRect();
                    // 如果页面在视口中
                    if (rect.top < viewportHeight && rect.bottom > 0) {
                        currentSection = index;
                    }
                }
            });
            
            // 更新大纲高亮
            const outlineItems = outlineList.querySelectorAll('.outline-item');
            outlineItems.forEach((item, i) => {
                if (i === currentSection) {
                    item.classList.add('bg-gray-100');
                } else {
                    item.classList.remove('bg-gray-100');
                }
            });
        }
        
        // 切换主题
        function toggleTheme() {
            const body = document.body;
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                body.classList.remove('bg-gray-100');
                body.classList.add('bg-gray-900');
                themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
                
                // 更新PDF容器背景
                pdfContainer.classList.remove('bg-gray-100');
                pdfContainer.classList.add('bg-gray-800');
                
                // 更新所有已渲染页面的背景
                pageElements.forEach(el => {
                    el.classList.remove('bg-paper');
                    el.classList.add('bg-gray-700');
                });
            } else {
                body.classList.add('bg-gray-100');
                body.classList.remove('bg-gray-900');
                themeToggle.innerHTML = '<i class="fa fa-moon-o text-dark"></i>';
                
                // 更新PDF容器背景
                pdfContainer.classList.add('bg-gray-100');
                pdfContainer.classList.remove('bg-gray-800');
                
                // 更新所有已渲染页面的背景
                pageElements.forEach(el => {
                    el.classList.add('bg-paper');
                    el.classList.remove('bg-gray-700');
                });
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-dark text-white px-4 py-3 rounded-2xl shadow-elevation-4 z-50 opacity-0 transition-opacity duration-300 hover-lift';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 显示提示
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                
                // 完全隐藏后移除元素
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 初始化应用
        function initApp() {
            initEventListeners();
            handleResize(); // 初始化屏幕尺寸检测
            
            // 加载默认PDF
            const defaultPDF = 'https://y0o0y.online/笔记(1).pdf';
            loadPDF(defaultPDF);
        }
        
        // 当DOM加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>    