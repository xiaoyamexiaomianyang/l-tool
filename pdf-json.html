<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to JSON è½¬æ¢å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .description {
            color: #34495e;
            font-size: 1.1em;
        }
        .feature-section {
            margin: 40px 0;
        }
        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-area:hover {
            background-color: #f8f9fa;
        }
        .upload-area.active {
            background-color: #e8f4fa;
            border-color: #2980b9;
        }
        .upload-icon {
            font-size: 4em;
            color: #3498db;
            margin-bottom: 20px;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
            width: 48%; /* è°ƒæ•´æŒ‰é’®å®½åº¦ */
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .faq {
            margin-top: 40px;
        }
        .faq-item {
            margin-bottom: 20px;
        }
        .faq-question {
            font-weight: bold;
            color: #2c3e50;
        }
        .steps {
            margin: 40px 0;
        }
        .step {
            display: flex;
            margin-bottom: 20px;
        }
        .step-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .result-section {
            margin: 40px 0;
            display: none;
        }
        .json-preview {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow: auto;
            font-family: Consolas, monospace;
            font-size: 0.9em;
        }
        .progress-bar {
            height: 30px;
            background-color: #f3f3f3;
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
            display: none;
        }
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            margin-top: 10px;
            text-align: center;
            font-size: 0.9em;
            color: #555;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">PDF to JSON è½¬æ¢å™¨</div>
        <p class="description">å°†PDFå†…å®¹è½¬æ¢ä¸ºç»“æ„åŒ–JSONæ ¼å¼ï¼Œå¹¶é™„å¸¦é¡µé¢å…ƒæ•°æ®ã€‚éå¸¸é€‚åˆéœ€è¦ä»æ–‡æ¡£å­˜æ¡£å’ŒæŠ¥å‘Šä¸­è·å–æœºå™¨å¯è¯»æ•°æ®çš„å¼€å‘è€…ã€‚</p>
    </div>

    <div class="feature-section">
        <h2 class="section-title">ä»€ä¹ˆæ˜¯PDFè½¬JSON</h2>
        <p>è¿™æ¬¾è½¬æ¢å™¨å°†PDFæ–‡æ¡£è½¬æ¢ä¸ºåŒ…å«æå–æ–‡æœ¬å†…å®¹ã€é¡µé¢çº§ç»“æ„å’Œå…ƒæ•°æ®çš„JSONæ ¼å¼ã€‚éå¸¸é€‚åˆéœ€è¦ä¸ºAPIã€æ•°æ®åˆ†ææµç¨‹å’Œå†…å®¹è¿ç§»é¡¹ç›®å‡†å¤‡ç»“æ„åŒ–æ•°æ®çš„å¼€å‘è€…ã€‚</p>
    </div>

    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“‚</div>
        <p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
        <input type="file" id="fileInput" accept=".pdf" style="display: none;">
        <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
    </div>

    <div class="progress-bar" id="progressBar">
        <div class="progress" id="progress"></div>
    </div>
    <div class="progress-text" id="progressText">å‡†å¤‡è½¬æ¢...</div>

    <div class="result-section" id="resultSection">
        <h2 class="section-title">è½¬æ¢ç»“æœ</h2>
        <div class="json-preview" id="jsonPreview"></div>
        <div class="btn-container">
            <button class="btn" id="convertBtn">è½¬æ¢</button>
            <button class="btn" id="downloadBtn">ä¸‹è½½JSONæ–‡ä»¶</button>
        </div>
    </div>

    <div class="steps">
        <h2 class="section-title">ä½¿ç”¨æ–¹æ³•</h2>
        <div class="step">
            <div class="step-number">1</div>
            <div>ä¸Šä¼ PDFæ–‡ä»¶</div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div>å¯åŠ¨è½¬æ¢</div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div>ä¸‹è½½JSONæ–‡ä»¶</div>
        </div>
        <div class="step">
            <div class="step-number">4</div>
            <div>ä½¿ç”¨åº”ç”¨ç¨‹åºæˆ–ç¼–è¾‘å™¨è§£æ</div>
        </div>
    </div>

    <div class="faq">
        <h2 class="section-title">å¸¸è§é—®é¢˜</h2>
        <div class="faq-item">
            <div class="faq-question">Q: æ–‡æœ¬å¦‚ä½•ç»„ç»‡ï¼Ÿ</div>
            <div class="faq-answer">A: æ¯é¡µæ–‡æœ¬å•ç‹¬å­˜å‚¨ï¼Œé™„å¸¦é¡µç å’Œå­—ç¬¦/è¯æ•°ç»Ÿè®¡ã€‚</div>
        </div>
        <div class="faq-item">
            <div class="faq-question">Q: æ˜¯å¦ä¿ç•™æ ¼å¼ï¼Ÿ</div>
            <div class="faq-answer">A: ä¸ä¿ç•™ï¼Œä»…è½¬æ¢çº¯æ–‡æœ¬å†…å®¹ã€‚åŠ ç²—/æ–œä½“ç­‰æ ¼å¼ä¸ä¼šè¢«ä¿ç•™ã€‚</div>
        </div>
        <div class="faq-item">
            <div class="faq-question">Q: å¦‚ä½•å¤„ç†è¡¨æ ¼ï¼Ÿ</div>
            <div class="faq-answer">A: è¡¨æ ¼è½¬ä¸ºçº¯æ–‡æœ¬å½¢å¼ï¼Œä¿ç•™é—´è·ã€‚å¯èƒ½éœ€è¦é¢å¤–å¤„ç†ã€‚</div>
        </div>
        <div class="faq-item">
            <div class="faq-question">Q: éæ‹‰ä¸å­—ç¬¦æ€ä¹ˆåŠï¼Ÿ</div>
            <div class="faq-answer">A: é‡‡ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒå¤§å¤šæ•°è¯­è¨€ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€æ—¥æ–‡å’Œé˜¿æ‹‰ä¼¯æ–‡ã€‚</div>
        </div>
        <div class="faq-item">
            <div class="faq-question">Q: èƒ½å¤„ç†å¤§å‹PDFå—ï¼Ÿ</div>
            <div class="faq-answer">A: 50MBä»¥ä¸‹æ–‡ä»¶æ•ˆæœæœ€ä½³ã€‚è¾ƒå¤§æ–‡æ¡£å¯èƒ½å› æµè§ˆå™¨ä¸åŒå¯¼è‡´å†…å­˜é—®é¢˜ã€‚</div>
        </div>
    </div>

    <!-- å¼•å…¥pdf.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <script>
        // é…ç½®pdf.js
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const convertBtn = document.getElementById('convertBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            const resultSection = document.getElementById('resultSection');
            const jsonPreview = document.getElementById('jsonPreview');
            
            let selectedFile = null;
            let jsonResult = null;
            let totalPages = 0;
            let isConverted = false; // æ ‡è®°æ˜¯å¦å·²å®Œæˆè½¬æ¢

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            updateConvertBtn();

            // å¤„ç†æ–‡ä»¶é€‰æ‹©
            selectFileBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    updateUploadArea();
                    updateConvertBtn(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼ˆåŒ…å«è½¬æ¢æŒ‰é’®ï¼‰
                    resultSection.style.display = 'block';
                    
                    // å¦‚æœæ˜¯ç»§ç»­è½¬æ¢çš„æƒ…å†µï¼Œé‡ç½®ç»“æœé¢„è§ˆ
                    if (isConverted) {
                        jsonPreview.textContent = '';
                    }
                }
            });

            // å¤„ç†æ‹–æ”¾
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length > 0) {
                    selectedFile = e.dataTransfer.files[0];
                    updateUploadArea();
                    updateConvertBtn(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼ˆåŒ…å«è½¬æ¢æŒ‰é’®ï¼‰
                    resultSection.style.display = 'block';
                    
                    // å¦‚æœæ˜¯ç»§ç»­è½¬æ¢çš„æƒ…å†µï¼Œé‡ç½®ç»“æœé¢„è§ˆ
                    if (isConverted) {
                        jsonPreview.textContent = '';
                    }
                }
            });

            // æ›´æ–°ä¸Šä¼ åŒºåŸŸçŠ¶æ€
            function updateUploadArea() {
                if (selectedFile) {
                    uploadArea.innerHTML = `
                        <div class="upload-icon">ğŸ“„</div>
                        <p>å·²é€‰æ‹©æ–‡ä»¶: <strong>${selectedFile.name}</strong></p>
                        <p class="text-sm">å¤§å°: ${formatFileSize(selectedFile.size)}</p>
                    `;
                } else {
                    uploadArea.innerHTML = `
                        <div class="upload-icon">ğŸ“‚</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                        <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                        <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                    `;
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    document.getElementById('selectFileBtn').addEventListener('click', () => {
                        fileInput.click();
                    });
                }
            }

            // æ›´æ–°è½¬æ¢æŒ‰é’®çŠ¶æ€å’Œæ–‡æœ¬
            function updateConvertBtn() {
                if (isConverted && selectedFile) {
                    convertBtn.textContent = "è½¬æ¢";
                    convertBtn.disabled = false;
                } else if (isConverted && !selectedFile) {
                    convertBtn.textContent = "ç»§ç»­è½¬æ¢";
                    convertBtn.disabled = false;
                } else if (selectedFile) {
                    convertBtn.textContent = "è½¬æ¢";
                    convertBtn.disabled = false;
                } else {
                    convertBtn.textContent = "è½¬æ¢";
                    convertBtn.disabled = true;
                }
            }

            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            convertBtn.addEventListener('click', () => {
                if (isConverted && !selectedFile) {
                    // å¦‚æœå·²è½¬æ¢ä¸”æ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€
                    resetForNewConversion();
                } else if (selectedFile) {
                    // å¦‚æœæœ‰é€‰æ‹©æ–‡ä»¶ï¼Œæ‰§è¡Œè½¬æ¢æˆ–é‡æ–°è½¬æ¢
                    if (isConverted) {
                        // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
                        jsonResult = null;
                        jsonPreview.textContent = '';
                        progressBar.style.display = 'none';
                        progress.style.width = '0%';
                        progressText.textContent = 'å‡†å¤‡è½¬æ¢...';
                        
                        // æ˜¾ç¤ºè¿›åº¦æ¡
                        progressBar.style.display = 'block';
                        
                        // æ‰§è¡Œé‡æ–°è½¬æ¢
                        parsePDF(selectedFile);
                    } else {
                        // æ‰§è¡Œé¦–æ¬¡è½¬æ¢
                        startConversion();
                    }
                }
            });

            // é‡ç½®ä¸ºæ–°çš„è½¬æ¢
            function resetForNewConversion() {
                selectedFile = null;
                isConverted = false;
                resultSection.style.display = 'none';
                uploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“‚</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                `;
                document.getElementById('selectFileBtn').addEventListener('click', () => {
                    fileInput.click();
                });
                updateConvertBtn();
            }

            // å¼€å§‹è½¬æ¢
            function startConversion() {
                if (!selectedFile) return;
                
                // æ˜¾ç¤ºè¿›åº¦æ¡
                progressBar.style.display = 'block';
                progress.style.width = '0%';
                progressText.textContent = 'å‡†å¤‡è½¬æ¢...';
                
                // è§£æPDFæ–‡ä»¶
                parsePDF(selectedFile);
            }

            // è§£æPDFæ–‡ä»¶
            function parsePDF(file) {
                const fileReader = new FileReader();
                
                fileReader.onload = function() {
                    const typedArray = new Uint8Array(this.result);
                    
                    // åŠ è½½PDFæ–‡ä»¶
                    pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                        totalPages = pdf.numPages;
                        const pages = [];
                        let processedPages = 0;
                        
                        // è¿›åº¦æ›´æ–°å‡½æ•°
                        function updateProgress(currentPage, totalPages) {
                            const progressPercent = Math.floor((currentPage / totalPages) * 100);
                            progress.style.width = `${progressPercent}%`;
                            progressText.textContent = `æ­£åœ¨å¤„ç†ç¬¬ ${currentPage}/${totalPages} é¡µ...`;
                        }
                        
                        // é€é¡µè§£æ
                        function processPage(pageNum) {
                            return pdf.getPage(pageNum).then(function(page) {
                                console.log(`å¼€å§‹è§£æç¬¬ ${pageNum} é¡µ`);
                                
                                return page.getTextContent({
                                    normalizeWhitespace: true,
                                    disableCombineTextItems: false
                                }).then(function(textContent) {
                                    // ä¼˜åŒ–æ–‡æœ¬æå–é€»è¾‘ï¼Œæ”¹è¿›ç‰¹æ®Šå­—ç¬¦å¤„ç†
                                    let pageText = '';
                                    let lastY = null;
                                    
                                    if (textContent.items && textContent.items.length > 0) {
                                        textContent.items.forEach(function(item) {
                                            if (typeof item.str === 'string') {
                                                // è§„èŒƒåŒ–Unicodeå­—ç¬¦
                                                const normalizedText = item.str.normalize('NFKC');
                                                
                                                // å¤„ç†æ¢è¡Œå’Œæ®µè½
                                                if (lastY !== null && Math.abs(item.transform[5] - lastY) > 10) {
                                                    pageText += '\n';
                                                }
                                                
                                                // æ·»åŠ è§„èŒƒåŒ–åçš„æ–‡æœ¬
                                                pageText += normalizedText;
                                                lastY = item.transform[5];
                                            }
                                        });
                                    }
                                    
                                    const pageInfo = {
                                        pageNumber: pageNum,
                                        text: pageText,
                                        characterCount: pageText.length,
                                        wordCount: pageText.trim().split(/\s+/).filter(word => word.length > 0).length
                                    };
                                    
                                    pages.push(pageInfo);
                                    processedPages++;
                                    updateProgress(processedPages, totalPages);
                                    
                                    console.log(`å®Œæˆè§£æç¬¬ ${pageNum} é¡µï¼Œå­—ç¬¦æ•°: ${pageText.length}`);
                                    return pageInfo;
                                });
                            }).catch(function(error) {
                                console.error(`è§£æç¬¬ ${pageNum} é¡µæ—¶å‡ºé”™:`, error);
                                progressText.textContent = `è§£æç¬¬ ${pageNum} é¡µæ—¶å‡ºé”™ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€é¡µ...`;
                                // å³ä½¿æŸé¡µè§£æå¤±è´¥ï¼Œä¹Ÿç»§ç»­å¤„ç†å…¶ä»–é¡µ
                                return null;
                            });
                        }
                        
                        // é¡ºåºå¤„ç†æ‰€æœ‰é¡µé¢
                        let pagePromises = [];
                        for (let i = 1; i <= totalPages; i++) {
                            pagePromises.push(processPage(i));
                        }
                        
                        // æ‰€æœ‰é¡µé¢å¤„ç†å®Œæˆå
                        Promise.all(pagePromises).then(function(results) {
                            // è¿‡æ»¤æ‰è§£æå¤±è´¥çš„é¡µé¢
                            const validPages = results.filter(page => page !== null);
                            
                            // åˆ›å»ºJSONç»“æœ
                            jsonResult = {
                                metadata: {
                                    filename: file.name,
                                    size: file.size,
                                    created: new Date().toISOString(),
                                    pages: totalPages,
                                    successfullyParsed: validPages.length,
                                    language: "zh-CN",
                                    characterEncoding: "UTF-8"
                                },
                                pages: validPages
                            };
                            
                            progressText.textContent = `è½¬æ¢å®Œæˆï¼æˆåŠŸè§£æ ${validPages.length}/${totalPages} é¡µ`;
                            
                            // æ ‡è®°ä¸ºå·²è½¬æ¢
                            isConverted = true;
                            
                            // æ˜¾ç¤ºç»“æœ
                            displayResult(jsonResult);
                            
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            updateConvertBtn();
                        });
                    }).catch(function(error) {
                        console.error('è§£æPDFæ—¶å‡ºé”™:', error);
                        progressText.textContent = `è§£æPDFæ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`;
                        progressBar.style.display = 'none';
                    });
                };
                
                fileReader.readAsArrayBuffer(file);
            }

            // æ˜¾ç¤ºè½¬æ¢ç»“æœ
            function displayResult(jsonData) {
                // éšè—è¿›åº¦æ¡
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                resultSection.style.display = 'block';
                
                // æ ¼å¼åŒ–JSONå¹¶æ˜¾ç¤º
                const formattedJson = JSON.stringify(jsonData, null, 2);
                jsonPreview.textContent = formattedJson;
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }

            // ä¸‹è½½JSONæ–‡ä»¶
            downloadBtn.addEventListener('click', () => {
                if (!jsonResult) return;
                
                const blob = new Blob([JSON.stringify(jsonResult, null, 2)], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name.replace('.pdf', '.json');
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
            });
        });
    </script>
</body>
</html>
